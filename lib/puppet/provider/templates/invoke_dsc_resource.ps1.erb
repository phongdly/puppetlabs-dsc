$script:ErrorActionPreference = 'Stop'
$script:WarningPreference     = 'SilentlyContinue'

$response = @{
  indesiredstate = $false
  rebootrequired = $false
  errormessage   = ''
}

$invokeParams = @{
  Name          = '<%= resource[:dscmeta_resource_friendly_name] %>'
  Method        = '<%= dsc_invoke_method %>'
  Property      = @{
<% dsc_parameters.each do |p| -%>
    <%- name = p.name.to_s.gsub(/^dsc_/,'')
    value = format_dsc_value(p.value)
    if name == 'ensure' && dsc_invoke_method == 'test'
      value = "\'#{resource.parameters[:ensure].default.to_s}\'"
    elsif p.mof_is_embedded? && p.mof_type != 'MSFT_KeyValuePair'
      vals = p.value.is_a?(Hash) ? [p.value] : p.value
      vals = vals.collect do |v|
        "(New-CimInstance -ClassName '#{p.mof_type.gsub('[]','')}' -ClientOnly -Property #{format_dsc_value(v)})"
      end
      value = "[CimInstance[]]@(#{vals.join(',')})"
    end
    -%>
    <%= name %> = <%= value %>
<% end -%>
  }<% if resource.parameters[:dscmeta_module_version] %>
  ModuleName = @{
    ModuleName      = <%= "\"#{resource[:dscmeta_module_name]}\"" %>
    RequiredVersion = <%= "\"#{resource[:dscmeta_module_version]}\"" %>
  }
<% else %>
  ModuleName = <%= "\"#{resource[:dscmeta_module_name]}\"" %>
<% end -%>
}

try{
    $result = Invoke-DscResource @invokeParams
}catch{
  $response.errormessage   = $_.Exception.Message
  return ($response | ConvertTo-Json -Compress)
}

# keep the switch for when Test passes back changed properties
switch ($invokeParams.Method) {
  'Test' {
    $response.indesiredstate = $result.InDesiredState
    return ($response | ConvertTo-Json -Compress)
  }
  'Set' {
    $response.indesiredstate = $true
    $response.rebootrequired = $result.RebootRequired
    return ($response | ConvertTo-Json -Compress)
  }
}
